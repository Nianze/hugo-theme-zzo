{{ if .Site.Params.enableBusuanzi }}
  <!-- Primary busuanzi CDN -->
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" onerror="loadBusuanziFallback()"></script>
  
  <!-- Enhanced busuanzi service with fallbacks -->
  <script>
    {{ $enableLocalCounter := .Site.Params.enableLocalCounter | default false }}
    var enableLocalCounter = JSON.parse({{ $enableLocalCounter | jsonify }});
    var busuanziLoaded = false;
    
    // Function to update all counters
    function updateAllCounters() {
      // Update site-wide counters
      var uvElem = document.getElementById('busuanzi_value_site_uv');
      var pvElem = document.getElementById('busuanzi_value_site_pv');
      var pagePvElem = document.getElementById('busuanzi_value_page_pv');
      
      if (uvElem && uvElem.textContent === '...') {
        uvElem.textContent = 'Loading...';
      }
      if (pvElem && pvElem.textContent === '...') {
        pvElem.textContent = 'Loading...';
      }
      if (pagePvElem && pagePvElem.textContent === '...') {
        pagePvElem.textContent = 'Loading...';
      }
    }
    
    function loadBusuanziFallback() {
      console.log('Primary busuanzi CDN failed, trying fallback...');
      var script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/busuanzi.pure.mini.js';
      script.async = true;
      script.onerror = function() {
        console.log('Fallback busuanzi CDN also failed');
        if (enableLocalCounter) {
          console.log('Using local counter as fallback');
          useLocalCounter();
        } else {
          // Show error message for all counters
          document.querySelectorAll('.busuanzi__item--number').forEach(function(elem) {
            elem.textContent = 'N/A';
          });
          var pagePvElem = document.getElementById('busuanzi_value_page_pv');
          if (pagePvElem) {
            pagePvElem.textContent = 'N/A';
          }
        }
      };
      script.onload = function() {
        console.log('Fallback busuanzi CDN loaded successfully');
        busuanziLoaded = true;
      };
      document.head.appendChild(script);
    }
    
    // Local counter fallback
    function useLocalCounter() {
      console.log('Initializing local counter system...');
      
      // Get stored values or initialize
      var sitePV = localStorage.getItem('site_pv') || 0;
      var siteUV = localStorage.getItem('site_uv') || 0;
      
      // Increment page view for this visit
      sitePV = parseInt(sitePV) + 1;
      localStorage.setItem('site_pv', sitePV);
      
      // Check if this is a new visitor (simple check)
      var lastVisit = localStorage.getItem('last_visit');
      var today = new Date().toDateString();
      if (lastVisit !== today) {
        siteUV = parseInt(siteUV) + 1;
        localStorage.setItem('site_uv', siteUV);
        localStorage.setItem('last_visit', today);
      }
      
      // Update site-wide counters
      var uvElem = document.getElementById('busuanzi_value_site_uv');
      var pvElem = document.getElementById('busuanzi_value_site_pv');
      
      if (uvElem) {
        uvElem.textContent = siteUV;
        uvElem.title = 'Local counter (unique visitors)';
      }
      if (pvElem) {
        pvElem.textContent = sitePV;
        pvElem.title = 'Local counter (page views)';
      }
      
      // Handle individual page view counter
      var pagePvElem = document.getElementById('busuanzi_value_page_pv');
      if (pagePvElem) {
        // Get page-specific view count
        var pageUrl = window.location.pathname;
        var pageKey = 'page_pv_' + btoa(pageUrl).replace(/[^a-zA-Z0-9]/g, '');
        var pagePV = localStorage.getItem(pageKey) || 0;
        pagePV = parseInt(pagePV) + 1;
        localStorage.setItem(pageKey, pagePV);
        
        pagePvElem.textContent = pagePV;
        pagePvElem.title = 'Local counter (page views)';
      }
    }
    
    // Check if busuanzi loaded successfully after 3 seconds
    setTimeout(function() {
      if (typeof busuanzi === 'undefined' && !busuanziLoaded) {
        console.log('Busuanzi not loaded, trying fallback...');
        loadBusuanziFallback();
      } else {
        console.log('Busuanzi loaded successfully');
        busuanziLoaded = true;
      }
    }, 3000);
    
    // Handle page view counters that might appear later
    document.addEventListener('DOMContentLoaded', function() {
      updateAllCounters();
      
      // Check for page view counter after DOM is loaded
      setTimeout(function() {
        var pagePvElem = document.getElementById('busuanzi_value_page_pv');
        if (pagePvElem && pagePvElem.textContent === '...' && !busuanziLoaded) {
          // If busuanzi hasn't loaded yet, try fallback
          loadBusuanziFallback();
        }
      }, 2000);
    });
    
    // Monitor for counter updates
    var observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList') {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1 && node.id === 'busuanzi_value_page_pv') {
              if (node.textContent === '...' && !busuanziLoaded) {
                setTimeout(function() {
                  if (node.textContent === '...') {
                    loadBusuanziFallback();
                  }
                }, 1000);
              }
            }
          });
        }
      });
    });
    
    // Start observing
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  </script>
{{ end }}